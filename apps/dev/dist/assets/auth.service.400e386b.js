import{c as f}from"./event-emitter.2752b338.js";import{m}from"./machine.cc32e4a0.js";const h={initialising:{tokenInvalid:()=>"refreshingToken",tokenValid:()=>"loggedIn"},loggedIn:{fetchUserFailure:()=>"loggedOut",logout:()=>"loggedOut"},loggingIn:{loginSuccess:()=>"loggedIn",loginFailure:()=>"loggedOut"},loggedOut:{clickLogin:()=>"loginForm",clickSignup:()=>"signupForm",fetchUserSuccess:()=>"loggedIn"},loginForm:{cancelLogin:()=>"loggedOut",submitLoginForm:()=>"loggingIn"},refreshingToken:{refreshTokenSuccess:()=>"loggedIn",refreshTokenFailure:()=>"loggedOut"},signingUp:{signupFailure:()=>"loggedOut",signupSuccess:()=>"loggedOut"},signupForm:{cancelSignup:()=>"loggedOut",submitSignupForm:()=>"signingUp"}};async function k(t){const i=f(),e=m(h,{initialState:"initialising"});return r(),e.onEnter(n=>{i.emit("stateChange",n)}),{...i,cancelLogin:()=>{e.cancelLogin()},cancelSignup:()=>{e.cancelSignup()},clickLogin:()=>{e.clickLogin()},clickSignup:()=>{e.clickSignup()},submitLoginForm:u,submitSignupForm:l};async function s(){try{const n=await t.user();g(n)?e.fetchUserFailure():(e.fetchUserSuccess(),i.emit("user",n))}catch{e.fetchUserFailure()}}async function r(){try{if(await t.checkLocalUser())e.tokenValid();else{e.tokenInvalid();try{const o=await t.refreshToken();if(g(o))e.refreshTokenFailure();else{e.refreshTokenSuccess();const{user:c,...a}=o;i.emit("newToken",a)}}catch{e.refreshTokenFailure();return}}s()}catch(n){throw n}}async function u(n,o){try{await e.submitLoginForm()==="loggingIn"&&await t.login(n,o),e.loginSuccess()}catch{e.loginFailure()}}async function l(n,o){try{await e.submitSignupForm()==="signingUp"&&await t.signUp(n,o),e.signupSuccess()}catch{e.signupFailure()}}}function g(t){const i=t;return typeof i.code=="number"&&typeof i.msg=="string"||typeof i.error=="string"||i===!1}export{k as createAuth};
