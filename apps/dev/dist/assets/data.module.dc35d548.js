import{c as M}from"./event-emitter.2752b338.js";import{m as O}from"./machine.cc32e4a0.js";import{c as E}from"./index.9b704175.js";function I(e){return function(n,t){const o=n||e;return t.type==="__crux-query__"?{...o,[t.meta.id]:{...o[t.meta.id],...t.payload}}:n||e}}function A({fetchFn:e,fetchParams:r,getState:n,keepUnusedDataFor:t=60,maxRetryCount:o=3,pollingInterval:p=60,setState:h}){const a=E();let u=0,f=0,S,l;const c=O({idle:{pollTimeoutStart:()=>"waitingForNextFetch",fetch:()=>"fetching",forceFetch:()=>"fetching",mutate:()=>"mutating"},fetching:{fetchFailure:()=>u===o?"idle":(u+=1,"fetching"),fetchSuccess:()=>"idle",selfDestructStart:()=>"selfDestructing"},selfDestructing:{cancelSelfDestruct:()=>"idle",selfDestructTimeout:()=>"idle"},mutating:{mutateFailure:()=>u===o?"idle":(u+=1,"mutating"),mutateSuccess:()=>"idle"},waitingForNextFetch:{forceFetch:()=>"fetching",mutate:()=>"mutating",pollTimeout:()=>"fetching"}},{initialState:"idle"});c.onIdle(()=>{p!==null&&a.add(c.pollTimeoutStart),a.flush()});async function q(){h({loading:!0,updating:n().data!==null});try{const i=await e(...r);return c.fetchSuccess(),h({data:i,loading:!1,updating:!1}),i}catch(i){c.fetchFailure(),h({error:i,loading:!1,updating:!1})}}return c.onWaitingForNextFetch(()=>{l=setTimeout(()=>{c.pollTimeout()},p)}),c.onExit(({action:i,current:s})=>{s==="selfDestructing"&&i!=="selfDestructTimeout"&&clearTimeout(S),s==="waitingForNextFetch"&&clearTimeout(l),["fetching","mutating"].includes(s)&&(u=0)}),{addSubscriber:b,mutate:v,refetch:F,removeSubscriber:_};function b(){f+=1,c.cancelSelfDestruct()}async function D(i,...s){const{query:x,optimistic:g,options:d}=i,{refetchOnSuccess:y}=d,T=n();if(g){const m=g==null?void 0:g(...s),w=R(m)?m(n().data):m;h({data:w,loading:!0,updating:T.data!==null})}try{const m=await x(...s),w=R(m)?await m(n().data):m;return h({data:i.options.refetchOnSuccess===!1?w:T.data,loading:!1,updating:!1}),c.mutateSuccess(),y&&c.fetch(),w}catch(m){h({error:m,loading:!1,updating:!1}),c.mutateFailure()}}function v(i,...s){return c.mutate()?D(i,...s):a.add(D,i,...s)}function F(i=!1){return(i?c.forceFetch():c.fetch())?q():null}function _(){f-=1,f===0&&(c.selfDestructStart(),S=setTimeout(()=>{c.selfDestructTimeout()},t))}}function R(e){return typeof e=="function"}function C(e="crux"){let r,n;const t=new Map;return{createResource:h,middleware:o,reducer:I({}),reducerId:e};function o(a){return(!r||!n)&&(r=u=>(console.log("query dispatch: ",u),a.dispatch(u)),n=a.getState),function(f){return function(l){f(l)}}}function p(a){return function(f){return r({meta:{id:a},payload:f,type:"__crux-query__"})}}function h(a,u){return{subscribe:f};function f(...S){var i,s,x,g;const l=j(a,S),N=M();if(!t.has(l)){const d=p(l);t.set(l,A({fetchFn:u.query,fetchParams:S,getState:()=>F(n()),keepUnusedDataFor:(i=u.options)==null?void 0:i.keepUnusedDataFor,maxRetryCount:(s=u.options)==null?void 0:s.maxRetryCount,pollingInterval:(x=u.options)==null?void 0:x.pollingInterval,setState:d})),d({data:null,error:null,loading:!1,updating:!1})}const{addSubscriber:c,mutate:q,refetch:b,removeSubscriber:D}=t.get(l);return c(),((g=u.options)==null?void 0:g.lazy)===!1&&b(),{...v(),...N,getState:()=>F(n()),refetch:b,select:F,unsubscribe:_};function v(){const d={};return Object.keys(u.mutations).forEach(y=>{d[y]=async function(...T){return await q(u.mutations[y],...T)}}),d}function F(d){var y;return(y=d[e])==null?void 0:y[l]}function _(){D()}}}}function j(e,r){return r.length?`${e}|${r.map(n=>JSON.stringify(n)).join("|")}`:e}function k(e){return e.data}function z(e,r){return e===null?e:e.filter(n=>r!==n.id)}function U(e,r){if(e===null)return e;const n=e==null?void 0:e.findIndex(t=>t.id===r.id);return n===-1||(e[n]={...e[n],...r}),e}function P(e,r){return e("users",{query:()=>r.getAll().then(k).catch(t=>{throw t}),mutations:{create:{query:t=>r.post(t)},delete:{query:t=>r.delete(t),optimistic:t=>o=>z(o,t)},update:{query:t=>o=>r.put(t).then(p=>p.data?U(o,p.data):o),optimistic:t=>o=>U(o,t),options:{refetchOnSuccess:!1}}},options:{lazy:!0,keepUnusedDataFor:60,pollingInterval:360}}).subscribe}function W(e,r){const{createResource:n,middleware:t,reducer:o}=C("data");return{middlewares:[t],reducer:o,services:{users:{factory:()=>Promise.resolve(()=>P(n,r))}}}}export{W as createDataModule};
