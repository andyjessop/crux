import{c as f}from"./event-emitter.2752b338.js";import{m}from"./machine.cc32e4a0.js";const h={initialising:{tokenInvalid:()=>"refreshingToken",tokenValid:()=>"loggedIn"},loggedIn:{fetchUserFailure:()=>"loggedOut",logout:()=>"loggedOut"},loggingIn:{loginSuccess:()=>"loggedIn",loginFailure:()=>"loggedOut"},loggedOut:{clickLogin:()=>"loginForm",clickSignup:()=>"signupForm",fetchUserSuccess:()=>"loggedIn",submitLoginForm:()=>"loggingIn",submitSignupForm:()=>"signingUp"},refreshingToken:{refreshTokenSuccess:()=>"loggedIn",refreshTokenFailure:()=>"loggedOut"},signingUp:{signupFailure:()=>"loggedOut",signupSuccess:()=>"unconfirmed"}};async function p(t){const i=f(),e=m(h,{initialState:"initialising"});return g(),e.onEnter(n=>{i.emit("stateChange",n)}),{...i,clickLogin:()=>{e.clickLogin()},clickSignup:()=>{e.clickSignup()},submitLoginForm:u,submitSignupForm:a};async function c(){try{const n=await t.user();r(n)?e.fetchUserFailure():(e.fetchUserSuccess(),i.emit("user",n))}catch{e.fetchUserFailure()}}async function g(){try{if(await t.checkLocalUser())e.tokenValid();else{e.tokenInvalid();try{const o=await t.refreshToken();if(r(o))e.refreshTokenFailure();else{e.refreshTokenSuccess();const{user:s,...l}=o;i.emit("newToken",l)}}catch{e.refreshTokenFailure();return}}c()}catch(n){throw n}}async function u(n,o){try{await e.submitLoginForm()==="loggingIn"&&await t.login(n,o),e.loginSuccess()}catch{e.loginFailure()}}async function a(n,o){try{await e.submitSignupForm()==="signingUp"&&await t.signUp(n,o),e.signupSuccess()}catch{e.signupFailure()}}}function r(t){const i=t;return typeof i.code=="number"&&typeof i.msg=="string"||typeof i.error=="string"||i===!1}export{p as createAuth};
